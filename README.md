# Мультимодальная RAG-система для поиска по продуктовой документации
- [Мультимодальная RAG-система для поиска по продуктовой документации](#мультимодальная-rag-система-для-поиска-по-продуктовой-документации)
  - [📋 Описание](#-описание)
    - [Ключевые особенности](#ключевые-особенности)
  - [🏗️ Архитектура системы](#️-архитектура-системы)
    - [Компоненты](#компоненты)
  - [✅ Что уже реализовано (промежуточный контроль)](#-что-уже-реализовано-промежуточный-контроль)
    - [1. Обработка документов](#1-обработка-документов)
    - [2. Индексация и хранение](#2-индексация-и-хранение)
    - [3. Поисковый пайплайн](#3-поисковый-пайплайн)
    - [4. Оптимизация производительности](#4-оптимизация-производительности)
    - [5. API и интерфейс](#5-api-и-интерфейс)
  - [🔜 Планы на финальный этап](#-планы-на-финальный-этап)
  - [🚀 Установка и запуск](#-установка-и-запуск)
    - [Требования](#требования)
    - [Установка зависимостей](#установка-зависимостей)
    - [Конфигурация](#конфигурация)
    - [Запуск](#запуск)
  - [📊 API Endpoints](#-api-endpoints)
    - [Добавление документа](#добавление-документа)
    - [Поиск](#поиск)
    - [Удаление документа](#удаление-документа)
  - [📁 Структура проекта](#-структура-проекта)

## 📋 Описание

Система обеспечивает высококачественный семантический поиск по документации в формате ReStructuredText (RST), включая:

- **Текстовый контент** с учетом иерархии документа (breadcrumbs)
- **Таблицы** с интеллектуальным chunking
- **Изображения** с автоматическим OCR и описанием UI через Vision-Language Model

### Ключевые особенности

- **Гибридный поиск**: комбинация векторного (dense) и keyword-based (BM25) retrieval
- **Query Expansion**: автоматическое расширение запросов через LLM
- **Cross-Encoder Reranking**: переранжирование результатов для максимальной точности
- **Мультимодальность**: единая обработка текста, таблиц и изображений
- **Оптимизация ресурсов**: ленивая загрузка моделей, кэширование индексов, auto-unload

***

## 🏗️ Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                      User Query                             │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │   Query Processor (LLM)       │
          │  Expansion: 1 → 2-3 queries   │
          └──────────────┬────────────────┘
                         ↓
          ┌──────────────────────────────┐
          │    Hybrid Retriever          │
          ├──────────────┬───────────────┤
          │  Vector DB   │  BM25 Search  │
          │  (ChromaDB)  │  (rank-bm25)  │
          └──────┬───────┴───────┬───────┘
                 └───────┬───────┘
                         ↓
              Top-K candidates (50-100)
                         ↓
          ┌──────────────────────────────┐
          │  Cross-Encoder Reranker      │
          │  (BAAI/bge-reranker-v2-m3)   │
          └──────────────┬───────────────┘
                         ↓
               Top-N results (5-10)
```

### Компоненты

| Модуль | Описание | Технологии |
|--------|----------|------------|
| **Document Processor** | Парсинг RST, извлечение таблиц, анализ изображений | pypandoc, docutils, Ollama VLM |
| **Vector Storage** | Хранение эмбеддингов | ChromaDB + nomic-embed-text |
| **Keyword Engine** | BM25 поиск с кэшированием | rank-bm25 |
| **Hybrid Retriever** | Объединение векторного и keyword поиска | Custom implementation |
| **Query Processor** | Расширение запросов | Qwen3 4B |
| **Reranker** | Финальное переранжирование | sentence-transformers |

***

## ✅ Что уже реализовано (промежуточный контроль)

### 1. Обработка документов

- Парсинг RST документов и конвертация в Markdown
- Извлечение и парсинг таблиц с docutils (обработка rowspan/colspan)
- Интеллектуальное разбиение таблиц на chunks с учетом размера
- Анализ изображений через VLM (OCR + UI description)
- Извлечение breadcrumbs для контекстуализации чанков

### 2. Индексация и хранение

- Векторное хранилище на ChromaDB
- Генерация эмбеддингов через Ollama (nomic-embed-text v1.5)
- Управление метаданными документов
- Операции добавления/удаления документов с rollback

### 3. Поисковый пайплайн

- BM25 keyword search с кэшированием индекса
- Векторный поиск с косинусной близостью
- Гибридный retrieval (fusion векторных и keyword результатов)
- Query Expansion через LLM (генерация 2-3 альтернативных запросов)
- Cross-Encoder reranking (BAAI/bge-reranker-v2-m3)

### 4. Оптимизация производительности

- Ленивая загрузка моделей (lazy loading)
- Автоматическая выгрузка моделей из памяти (auto-unload)
- Кэширование BM25 индекса на диск
- Batch processing для эмбеддингов

### 5. API и интерфейс

- FastAPI REST API (`app.py`)
- Конфигурация через TOML файл
- Структурированное логирование

***

## 🔜 Планы на финальный этап

1. Автоматическая генерация вопросов по чанкам документации (100-200 запросов с релевантными чанками)
2. Подсчет метрик:
    - Context Relevance (точность извлечения релевантных чанков)
    - Context Recall (полнота охвата необходимой информации)
    - Hit Rate @ K (процент правильных ответов в топ-K)
    - MRR (Mean Reciprocal Rank)
3. Сравнение с бейзлайном

***

## 🚀 Установка и запуск

### Требования

- Python 3.11+
- [Ollama](https://ollama.ai/) с установленными моделями:
  - `nomic-embed-text:v1.5` (эмбеддинги)
  - `qwen3-vl:4b-instruct` (Vision-Language)
  - `qwen3:4b-instruct` (Query Expansion)

### Установка зависимостей

```bash
# Установка через uv
uv sync

# Или через pip
pip install -e .
```

### Конфигурация

Отредактируйте `config.toml`:

```toml
[ollama]
base_url = "http://localhost:11434"
text_embedding_model = "nomic-embed-text:v1.5"
vlm_model = "qwen3-vl:4b-instruct"

[chunking]
chunk_size = 1024
chunk_overlap = 128

[search]
max_results = 5
retrieval_top_k = 50
```

### Запуск

```bash
# Запуск FastAPI сервера
python app.py
```

***

## 📊 API Endpoints

### Добавление документа

```http
POST /documents
Content-Type: application/json

{
  "rst_content": "...",
  "document_url": "https://...",
  "images_base_path": "/path/to/images/"
}
```

### Поиск

```http
POST /search
Content-Type: application/json

{
  "query": "Как создать правило качества?",
  "top_k": 5
}
```

### Удаление документа

```http
DELETE /documents/{file_id}
```

***

## 📁 Структура проекта

```
├── src/
│   ├── config.py                # Конфигурация системы
│   ├── rag/
│   │   ├── main.py              # Главный оркестратор RAGSystem
│   │   ├── ingestion.py         # Обработка документов
│   │   ├── storage.py           # Векторное хранилище
│   │   ├── search.py            # BM25 и гибридный поиск
│   │   ├── query_processing.py  # Query Expansion
│   │   ├── ranking.py           # Cross-Encoder reranker
│   │   └── schema.py            # Дата-классы
│   └── utils/
│       └── logging_config.py    # Логирование
├── app.py                       # FastAPI приложение
├── config.toml                  # Конфигурация
├── test_ragv4.py                # Тесты системы
└── notebooks/
    └── data_exploration_and_processing.ipynb
```
